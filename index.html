<!DOCTYPE html>
<html lang="en">
<!-- Previous head and style sections remain the same -->

<body>
    <div id="status-bar"></div>
    <div id="debug-info"></div>

    <div class="loading-screen" id="loading-screen">
        <h2>AI Chat</h2>
        <div class="loading-details" id="loading-details">Checking system...</div>
        <div class="loading-progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text">0%</div>
        <div class="stats-container">
            <div class="stat-box">
                <div class="stat-label">Downloaded</div>
                <div class="stat-value" id="downloaded-size">0 MB</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Speed</div>
                <div class="stat-value" id="download-speed">0 MB/s</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ETA</div>
                <div class="stat-value" id="eta">--:--</div>
            </div>
        </div>
        <div id="error-log" style="margin-top: 20px; color: #666; font-size: 12px; text-align: left; max-width: 300px;"></div>
    </div>

    <!-- Previous chat container HTML remains the same -->

    <script type="module">
        import * as webllm from 'https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm/dist/web-llm.js';

        let chat;
        const errorLog = document.getElementById('error-log');
        
        function log(message) {
            console.log(message);
            errorLog.innerHTML += message + '<br>';
            errorLog.scrollTop = errorLog.scrollHeight;
        }

        async function checkSystemRequirements() {
            log('Checking system requirements...');
            
            // Check WebAssembly
            if (typeof WebAssembly === 'undefined') {
                throw new Error('WebAssembly not supported');
            }
            log('âœ“ WebAssembly supported');

            // Check memory
            const memory = navigator.deviceMemory || 'unknown';
            log(`Device memory: ${memory}GB`);
            
            // Check processors
            const processors = navigator.hardwareConcurrency || 'unknown';
            log(`CPU cores: ${processors}`);

            // Check online status
            log(`Online status: ${navigator.onLine}`);

            // Check browser
            log(`Browser: ${navigator.userAgent}`);
        }

        async function initChat() {
            try {
                await checkSystemRequirements();
                
                log('Creating chat module...');
                chat = await webllm.ChatModule.create();
                log('Chat module created');

                // Set up progress tracking
                chat.setProgressCallback((progress) => {
                    log(`Progress update: ${JSON.stringify(progress)}`);
                    if (progress.type === "download") {
                        updateProgress(progress.loaded, progress.total || 2048 * 1024 * 1024); // 2GB estimate
                    }
                });

                log('Loading model...');
                updateLoadingStatus('Loading model (this may take a few minutes)...');

                // Try loading a smaller model first
                await chat.reload("TinyLlama-1.1B-Chat-v0.3", {
                    wasmUrl: 'https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm/lib/',
                    cacheUrl: './model-cache/',
                    maxThreads: 2, // Reduced threads for mobile
                    modelConfig: {
                        temperature: 0.7,
                        max_tokens: 50,
                        repetition_penalty: 1.1,
                        top_p: 0.9
                    }
                });

                log('Model loaded successfully');
                updateLoadingStatus('Setting up chat...');

                await chat.setSystemPrompt('You are a helpful AI assistant.');
                log('System prompt set');

                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('user-input').disabled = false;
                document.getElementById('send-button').disabled = false;

                addMessage("Hello! How can I help you today?", 'bot');

            } catch (error) {
                log(`Error: ${error.message}`);
                console.error('Full error:', error);
                updateLoadingStatus(`Error: ${error.message}. Check error log below.`);
            }
        }

        // Previous helper functions remain the same

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            log('Page loaded, starting initialization...');
            setTimeout(initChat, 1000);
        });

        // Handle visibility changes
        document.addEventListener('visibilitychange', () => {
            log(`Visibility changed: ${document.visibilityState}`);
        });

        // Monitor memory
        if (window.performance && window.performance.memory) {
            setInterval(() => {
                const memory = window.performance.memory;
                log(`Memory usage: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)}MB`);
            }, 5000);
        }
    </script>
</body>
</html>