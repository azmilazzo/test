<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat with Amy TTS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            color: #333;
            overflow: hidden;
            margin: 0;
            padding: 0;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-height: 60px;
            flex-shrink: 0;
            position: relative;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 0;
            flex: 1;
            min-width: 0;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .tts-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: rgba(255, 255, 255, 0.8);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .settings-btn:active {
            transform: scale(0.95);
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.assistant {
            align-self: flex-start;
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 6px;
            position: relative;
        }

        .message.system {
            align-self: center;
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.3);
            font-size: 0.9em;
            max-width: 90%;
            text-align: center;
        }

        .message-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            opacity: 0.7;
        }

        .control-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 0.8em;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        /* Input Area */
        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            max-width: 100%;
        }

        .message-input {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 22px;
            font-size: 16px;
            resize: none;
            font-family: inherit;
            line-height: 1.4;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #2d3748;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        /* Loading indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            align-self: flex-start;
            max-width: 80px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #a0aec0;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .app-container {
                height: 100vh;
                border-radius: 0;
            }

            .header {
                padding: 15px 15px;
                min-height: 65px;
                flex-wrap: nowrap;
            }

            .header h1 {
                font-size: 1.2em;
                margin-right: 10px;
            }

            .header-controls {
                gap: 12px;
                flex-shrink: 0;
            }

            .tts-toggle {
                font-size: 0.8em;
                white-space: nowrap;
            }

            .toggle-switch {
                width: 45px;
                height: 22px;
            }

            .toggle-slider {
                width: 18px;
                height: 18px;
            }

            .toggle-switch.active .toggle-slider {
                transform: translateX(23px);
            }

            .settings-btn {
                font-size: 0.8em;
                padding: 8px 10px;
                min-width: 50px;
            }

            .chat-messages {
                padding: 15px;
            }

            .message {
                max-width: 85%;
                font-size: 0.95em;
            }

            .input-container {
                padding: 15px;
            }

            .modal-content {
                margin: 10px;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 12px 12px;
                min-height: 60px;
            }

            .header h1 {
                font-size: 1.1em;
                margin-right: 8px;
            }

            .header-controls {
                gap: 10px;
            }

            .tts-toggle span {
                display: none; /* Hide emoji on very small screens */
            }

            .settings-btn {
                font-size: 0.75em;
                padding: 6px 8px;
                min-width: 45px;
            }

            .toggle-switch {
                width: 40px;
                height: 20px;
            }

            .toggle-slider {
                width: 16px;
                height: 16px;
            }

            .toggle-switch.active .toggle-slider {
                transform: translateX(20px);
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>🤖 AI Chat + Amy TTS</h1>
            <div class="header-controls">
                <div class="tts-toggle">
                    <span>🔊</span>
                    <div class="toggle-switch" id="ttsToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <button class="settings-btn" id="settingsBtn">⚙️ API</button>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    👋 Hi! I'm your AI assistant powered by DeepSeek. Configure your OpenRouter API key to start chatting!
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="Type your message here..."
                        rows="1"
                    ></textarea>
                    <button id="sendBtn" class="send-btn">
                        ➤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <h2>⚙️ API Configuration</h2>
            <div class="form-group">
                <label for="apiKeyInput">OpenRouter API Key:</label>
                <input 
                    type="password" 
                    id="apiKeyInput" 
                    placeholder="sk-or-..."
                    autocomplete="off"
                >
            </div>
            <div class="form-group">
                <label for="systemPromptInput">System Prompt (Optional):</label>
                <input 
                    type="text" 
                    id="systemPromptInput" 
                    placeholder="You are a helpful assistant..."
                    value="You are Amy, a helpful and friendly AI assistant. Respond naturally and conversationally."
                >
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="saveBtn">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        // VITS-Web TTS Class
        class VITSWeb {
            constructor() {
                this.isInitialized = false;
                this.audioContext = null;
            }

            async initialize() {
                if (this.isInitialized) return;
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.isInitialized = true;
                    return true;
                } catch (error) {
                    console.error('Failed to initialize VITS:', error);
                    return false;
                }
            }

            async synthesize(text) {
                if (!this.isInitialized) {
                    await this.initialize();
                }

                return new Promise((resolve, reject) => {
                    if (!('speechSynthesis' in window)) {
                        reject(new Error('Speech synthesis not supported'));
                        return;
                    }

                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // Find Amy-like voice
                    const voices = speechSynthesis.getVoices();
                    const preferredVoices = [
                        'Google US English',
                        'Microsoft Zira - English (United States)',
                        'Samantha',
                        'Alex',
                        'Victoria'
                    ];

                    let selectedVoice = null;
                    for (const preferred of preferredVoices) {
                        selectedVoice = voices.find(voice => 
                            voice.name.includes(preferred) || 
                            (voice.lang.includes('en') && voice.name.toLowerCase().includes('female'))
                        );
                        if (selectedVoice) break;
                    }

                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => voice.lang.startsWith('en')) || voices[0];
                    }

                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }

                    utterance.rate = 0.9;
                    utterance.pitch = 1.1;
                    utterance.volume = 0.8;

                    utterance.onend = () => resolve();
                    utterance.onerror = (event) => reject(new Error(`TTS failed: ${event.error}`));

                    speechSynthesis.speak(utterance);
                });
            }

            stop() {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
            }
        }

        // App State (using in-memory storage instead of localStorage)
        const appState = {
            apiKey: '',
            systemPrompt: 'You are Amy, a helpful and friendly AI assistant. Respond naturally and conversationally.',
            ttsEnabled: true,
            messages: []
        };

        // Initialize components
        const vits = new VITSWeb();
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const ttsToggle = document.getElementById('ttsToggle');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const systemPromptInput = document.getElementById('systemPromptInput');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // Message Management
        function addMessage(content, role, speak = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = content;

            // Add controls for assistant messages
            if (role === 'assistant') {
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'message-controls';
                controlsDiv.innerHTML = `
                    <button class="control-btn" onclick="speakMessage(this)" title="Speak">🔊</button>
                    <button class="control-btn" onclick="copyMessage(this)" title="Copy">📋</button>
                `;
                messageDiv.appendChild(controlsDiv);
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Auto-speak if TTS is enabled
            if (speak && appState.ttsEnabled && role === 'assistant') {
                speakText(content);
            }

            // Store message
            appState.messages.push({ role, content });
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typing = document.getElementById('typingIndicator');
            if (typing) {
                typing.remove();
            }
        }

        // TTS Functions
        async function speakText(text) {
            try {
                await vits.synthesize(text);
            } catch (error) {
                console.error('TTS Error:', error);
            }
        }

        window.speakMessage = function(btn) {
            const messageContent = btn.closest('.message').textContent;
            speakText(messageContent);
        };

        window.copyMessage = function(btn) {
            const messageContent = btn.closest('.message').textContent;
            navigator.clipboard.writeText(messageContent).then(() => {
                btn.textContent = '✓';
                setTimeout(() => btn.textContent = '📋', 1000);
            });
        };

        // OpenRouter API Integration
        async function sendToDeepSeek(userMessage) {
            if (!appState.apiKey) {
                throw new Error('Please configure your OpenRouter API key first');
            }

            const messages = [
                { role: 'system', content: appState.systemPrompt },
                ...appState.messages.slice(-10), // Keep last 10 messages for context
                { role: 'user', content: userMessage }
            ];

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${appState.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin || 'https://claude.ai',
                        'X-Title': 'AI Chat with Amy TTS',
                        'Origin': window.location.origin || 'https://claude.ai'
                    },
                    body: JSON.stringify({
                        model: 'deepseek/deepseek-chat-v3-0324:free',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 1000,
                        stream: false
                    })
                });

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error?.message || errorMessage;
                    } catch (e) {
                        // If we can't parse error JSON, use the default message
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                return data.choices[0].message.content;

            } catch (error) {
                // Handle different types of errors
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('❌ CORS Error: This app needs to be run from your own server or localhost to access the OpenRouter API. The Claude.ai preview environment blocks external API calls for security reasons.');
                } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    throw new Error('❌ Network Error: Unable to connect to OpenRouter API. Please check your internet connection and try again.');
                } else {
                    throw error; // Re-throw other errors as-is
                }
            }
        }

        // Demo/Fallback Response Function
        function getDemoResponse(userMessage) {
            const responses = [
                "I'm Amy, your AI assistant! However, I'm currently running in demo mode because external API calls are restricted in this preview environment.",
                "That's an interesting question! To get real AI responses, you'll need to download this code and run it on your own server or localhost.",
                "I'd love to help you with that! Unfortunately, I can only provide demo responses here. For full functionality, please run this app from your own environment.",
                "Great question! This is a demo response since we can't access the OpenRouter API from this preview. Copy the code to use it with real AI responses!",
                "I understand what you're asking! This preview shows how the chat interface works, but you'll need to run it locally for actual AI conversations."
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            return randomResponse + `\n\n💡 **How to use with real AI:**\n1. Copy this HTML code\n2. Save it as a .html file\n3. Open it in your browser\n4. Add your OpenRouter API key\n5. Enjoy full AI conversations!`;
        }

        // Chat Functions
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            messageInput.value = '';
            adjustTextareaHeight();

            // Show typing indicator
            showTypingIndicator();
            sendBtn.disabled = true;

            try {
                let response;
                
                if (appState.apiKey) {
                    // Try to get real AI response
                    try {
                        response = await sendToDeepSeek(message);
                    } catch (error) {
                        // If API fails, provide helpful error message and demo response
                        hideTypingIndicator();
                        addMessage(error.message, 'system');
                        
                        // Show demo response after error
                        showTypingIndicator();
                        setTimeout(() => {
                            hideTypingIndicator();
                            const demoResponse = getDemoResponse(message);
                            addMessage(demoResponse, 'assistant', true);
                        }, 1500);
                        return;
                    }
                } else {
                    // No API key, provide demo response
                    response = getDemoResponse(message);
                }
                
                // Hide typing and add response
                hideTypingIndicator();
                addMessage(response, 'assistant', true);
                
            } catch (error) {
                hideTypingIndicator();
                addMessage(`❌ Unexpected Error: ${error.message}`, 'system');
            } finally {
                sendBtn.disabled = false;
                messageInput.focus();
            }
        }

        // UI Event Handlers
        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        function toggleTTS() {
            appState.ttsEnabled = !appState.ttsEnabled;
            ttsToggle.classList.toggle('active', appState.ttsEnabled);
            
            if (!appState.ttsEnabled) {
                vits.stop();
            }
        }

        function showSettings() {
            apiKeyInput.value = appState.apiKey;
            systemPromptInput.value = appState.systemPrompt;
            settingsModal.classList.remove('hidden');
        }

        function hideSettings() {
            settingsModal.classList.add('hidden');
        }

        function saveSettings() {
            appState.apiKey = apiKeyInput.value.trim();
            appState.systemPrompt = systemPromptInput.value.trim() || 'You are Amy, a helpful and friendly AI assistant.';
            
            hideSettings();
            
            if (appState.apiKey) {
                addMessage('✅ API key configured successfully! You can now chat with me.', 'system');
            }
        }

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        messageInput.addEventListener('input', adjustTextareaHeight);

        ttsToggle.addEventListener('click', toggleTTS);
        settingsBtn.addEventListener('click', showSettings);
        saveBtn.addEventListener('click', saveSettings);
        cancelBtn.addEventListener('click', hideSettings);

        // Modal click outside to close
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                hideSettings();
            }
        });

        // Initialize app
        function init() {
            // Set initial TTS state
            ttsToggle.classList.toggle('active', appState.ttsEnabled);
            
            // Load voices
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => {
                    console.log('Voices loaded:', speechSynthesis.getVoices().length);
                };
            }
            
            // Focus input
            messageInput.focus();
            
            // Show initial setup message
            setTimeout(() => {
                if (!appState.apiKey) {
                    addMessage('🔑 Click the "API" button to configure your OpenRouter API key and start chatting!\n\n⚠️ **Note**: This preview environment has CORS restrictions. For full functionality:\n1. Copy this HTML code\n2. Save as a .html file\n3. Open in your browser\n4. Add your API key\n\nYou can still try the demo responses and TTS features here!', 'system');
                }
            }, 1000);
        }

        init();
    </script>
</body>
</html>
