<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat with Amy TTS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', 'Lucida Console', monospace;
            background: #000000;
            height: 100vh;
            color: #00FF00; /* Bright Green */
            overflow: hidden;
            margin: 0;
            padding: 0;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            position: relative; /* For scan lines pseudo-element */
        }

        body::before {
            content: "";
            position: fixed; /* Use fixed to cover the whole viewport, even if body content scrolls (though overflow is hidden here) */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                rgba(0, 255, 0, 0.03) 50%, /* Very faint green lines */
                transparent 50%
            );
            background-size: 100% 4px; /* Adjust line thickness and spacing */
            z-index: -1; /* Place it behind all content */
            pointer-events: none; /* Ensure it doesn't interfere with interactions */
            opacity: 0.3; /* Further reduce visibility */
        }

        @keyframes rainStream {
            0% {
                transform: translateY(-100%);
                opacity: 0;
            }
            50% {
                opacity: 0.3; /* Fade in */
            }
            100% {
                transform: translateY(100vh); /* Move down the full height of the viewport */
                opacity: 0; /* Fade out */
            }
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            background: transparent; /* Or a very dark, slightly translucent green/gray */
            /* backdrop-filter: blur(10px); */ /* Removed for Matrix theme */
            position: relative;
            overflow: hidden; /* Crucial to contain the pseudo-elements if they are positioned absolutely to the container */
        }

        .app-container::before { /* For the raining code effect */
            content: "01010101010101010101010101010101010101010101010101"; /* Example stream */
            position: absolute;
            top: 0;
            left: 10%; /* Position one stream */
            font-size: 10px;
            color: rgba(0, 255, 0, 0.1); /* Very faint green */
            writing-mode: vertical-rl; /* Characters fall downwards */
            text-orientation: mixed;
            white-space: nowrap;
            animation: rainStream 10s linear infinite;
            animation-delay: 0s;
            z-index: -1; 
            pointer-events: none;
            font-family: 'Courier New', 'Lucida Console', monospace; /* Ensure Matrix font */
        }

        .app-container::after {
            content: "11100010101010101010101010101010101010101010101010";  /* Different content */
            position: absolute;
            top: 0;
            left: 75%; /* Different position */
            font-size: 11px; /* Slightly different size */
            color: rgba(0, 255, 0, 0.09); /* Slightly different faintness */
            writing-mode: vertical-rl;
            text-orientation: mixed;
            white-space: nowrap;
            animation: rainStream 12s linear infinite; /* Different duration */
            animation-delay: -6s; /* Different delay, start partway */
            z-index: -1; 
            pointer-events: none;
            font-family: 'Courier New', 'Lucida Console', monospace;
        }

        /* Header */
        .header {
            background: #003300; /* Dark Green */
            color: #00FF00; /* Bright Green */
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); */ /* Removed for Matrix theme */
            border-bottom: 1px solid #00FF00; /* Thin bright green border */
            min-height: 60px;
            flex-shrink: 0;
            position: relative;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 0;
            flex: 1;
            min-width: 0;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .tts-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #002200; /* Darker Green/Black */
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #00FF00;
        }

        .toggle-switch.active {
            background: #004400; /* Darker Green */
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #008800; /* Dimmer green or dark gray */
            border-radius: 50%;
            transition: all 0.3s ease;
            /* box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); */ /* Removed */
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
            background: #00FF00; /* Bright Green */
        }

        .settings-btn {
            background: #000000; /* Black */
            border: 1px solid #00FF00; /* Bright Green */
            color: #00FF00; /* Bright Green */
            padding: 10px 12px;
            border-radius: 8px; /* Minimal rounding, can be set to 0 for sharper edges */
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: #00FF00; /* Bright Green */
            color: #000000; /* Black */
        }

        .settings-btn:active {
            transform: scale(0.95);
            background: #39FF14; /* Slightly different green for active */
            color: #000000;
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: transparent; /* Ensure it's dark */
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #001100; /* Very dark green, almost black */
            position: relative; 
            z-index: 1; /* This ensures .chat-messages (and its children) are above .app-container's pseudo-elements */
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            background: #002200; /* Darker green or dark gray/black */
            color: #00FF00; /* Bright Green */
            border-bottom-right-radius: 6px; /* Keep minimal rounding or set to 0 */
            border: 1px solid #00FF00; /* Optional: thin bright green border */
        }

        .message.assistant {
            align-self: flex-start;
            background: #001800; /* Slightly different shade of dark green */
            color: #00FF00; /* Bright Green */
            border: 1px solid #00FF00; /* Optional: thin bright green border */
            border-bottom-left-radius: 6px; /* Keep minimal rounding or set to 0 */
            position: relative;
        }

        .message.system {
            align-self: center;
            background: #002b00; /* Dark, with a subtle green tint */
            color: #39FF14; /* A slightly dimmer or different shade of green */
            border: 1px solid #00FF00; /* Thin bright green border */
            font-size: 0.9em;
            max-width: 90%;
            text-align: center;
        }

        .message-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            opacity: 0.7; /* Keep or adjust as needed */
            filter: brightness(150%); /* Make icons brighter green */
        }

        .control-btn {
            background: none; /* Or #000000 */
            border: 1px solid #00FF00; /* Bright Green */
            color: #00FF00; /* Bright Green */
            cursor: pointer;
            padding: 4px;
            border-radius: 4px; /* Minimal rounding or 0 */
            font-size: 0.8em;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: #00FF00; /* Bright Green */
            color: #000000; /* Black */
        }

        /* Input Area */
        .input-container {
            padding: 20px;
            background: #001100; /* Dark, matching overall theme */
            border-top: 1px solid #00FF00; /* Bright Green */
            position: relative; 
            z-index: 1; /* This ensures .input-container (and its children) are above .app-container's pseudo-elements */
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            max-width: 100%;
        }

        .message-input {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: 12px 16px;
            border: 2px solid #00FF00; /* Bright Green */
            border-radius: 0; /* Sharp edges */
            font-size: 16px;
            resize: none;
            font-family: inherit; /* Already monospace from body */
            line-height: 1.4;
            transition: all 0.3s ease;
            background: #000000; /* Black */
            color: #00FF00; /* Bright Green */
        }

        .message-input::placeholder {
            color: #008800; /* Dimmer green */
        }

        .message-input:focus {
            outline: none;
            border-color: #39FF14; /* Brighter Green */
            box-shadow: 0 0 0 3px rgba(0, 255, 0, 0.3); /* Green glow */
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border: 1px solid #00FF00;
            border-radius: 0; /* Sharp edges */
            background: #00FF00; /* Bright Green */
            color: #000000; /* Black icon/text */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            background: #39FF14;
            border-color: #39FF14;
            /* box-shadow: 0 4px 12px rgba(0, 255, 0, 0.3); */ /* Optional green shadow */
        }

        .send-btn:disabled {
            opacity: 0.5;
            background: #008800; /* Dimmer green */
            cursor: not-allowed;
            transform: none;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8); /* Semi-transparent black overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* Modal should be on top of everything */
            padding: 20px;
        }

        .modal-content {
            background: #000000; /* Black or very dark green */
            border-radius: 0; /* Sharp edges, or minimal like 4px */
            padding: 30px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #00FF00; /* Thin, bright green */
            color: #00FF00; /* Bright Green text */
            position: relative; /* Ensure modal content is above any potential pseudo elements on .modal itself */
            z-index: 1001;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #00FF00; /* Bright Green */
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #00FF00; /* Bright Green */
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #00FF00; /* Bright Green */
            border-radius: 0; /* Sharp edges */
            font-size: 16px;
            transition: all 0.3s ease;
            background: #001100; /* Very dark green */
            color: #00FF00; /* Bright Green */
        }

        .form-group input:focus {
            outline: none;
            border-color: #39FF14; /* Brighter Green */
            box-shadow: 0 0 0 3px rgba(0, 255, 0, 0.3); /* Green glow */
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid #00FF00; /* Bright Green */
            border-radius: 0; /* Sharp edges */
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #00FF00; /* Bright Green */
            color: #000000; /* Black */
        }
        .btn-primary:hover {
            background: #39FF14;
            border-color: #39FF14;
        }

        .btn-secondary {
            background: #000000; /* Black */
            color: #00FF00; /* Bright Green */
            border: 1px solid #00FF00; /* Bright Green */
        }
        .btn-secondary:hover {
            background: #002200; /* Dark Green on hover */
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        /* Loading indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #001800; /* Dark green, similar to assistant messages */
            border: 1px solid #00FF00; /* Bright green border */
            border-radius: 18px; /* Can be kept or sharpened */
            border-bottom-left-radius: 6px; /* Can be kept or sharpened */
            align-self: flex-start;
            max-width: 80px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #00FF00; /* Bright Green */
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* Custom Scrollbars for Matrix Theme */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #001100; /* Very dark green */
        }
        ::-webkit-scrollbar-thumb {
            background: #00FF00; /* Bright Green */
            border-radius: 0; /* Sharp edges */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #39FF14; /* Brighter Green */
        }
        /* For Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: #00FF00 #001100; /* thumb and track */
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .app-container {
                height: 100vh; /* Ensure full height */
                border-radius: 0; /* Remove border radius for full screen */
            }

            .header {
                padding: 12px 15px; /* Adjusted padding */
                min-height: 60px; /* Slightly reduced min-height */
                flex-wrap: nowrap;
            }

            .header h1 {
                font-size: 1.3em; /* Adjusted font size */
                margin-right: 10px;
            }

            .header-controls {
                gap: 10px; /* Reduced gap */
            }

            .tts-toggle {
                font-size: 0.85em; /* Adjusted font size */
            }

            .toggle-switch {
                width: 45px;
                height: 22px;
                /* Ensure border and slider are visible with Matrix theme */
            }

            .toggle-slider {
                width: 18px;
                height: 18px;
            }

            .toggle-switch.active .toggle-slider {
                transform: translateX(23px); /* Keep if visually correct */
            }

            .settings-btn {
                font-size: 0.85em; /* Adjusted font size */
                padding: 8px 10px;
                min-width: 55px; /* Ensure tapability */
            }

            .chat-messages {
                padding: 15px;
            }

            .message {
                max-width: 90%; /* Slightly increased max-width for better use of space */
                font-size: 0.95em; /* Keep font size for readability */
                padding: 10px 14px; /* Adjust padding */
            }
            
            .message.user, .message.assistant, .message.system {
                /* Reverting to sharper corners, closer to original desktop, or minimal radius if needed */
                /* border-radius: 10px; */ /* Removed from previous mobile adjustment for theme consistency */
                /* Original message border-radius: 18px, with specific corners at 6px. */
                /* Let's keep the main message radius and adjust if it looks off, rather than a blanket 10px. */
                /* No change here means it inherits desktop .message border-radius: 18px which is fine. */
            }

            .input-container {
                padding: 10px 15px; /* Reduced padding */
            }
            
            .input-wrapper {
                gap: 10px;
            }

            .message-input {
                padding: 10px 14px; /* Adjust padding */
                font-size: 15px; /* Ensure readability */
            }

            .send-btn {
                width: 40px; /* Ensure tappable size */
                height: 40px;
                font-size: 1.1em;
            }

            .modal-content {
                margin: 10px; /* Ensure it doesn't touch screen edges */
                padding: 20px;
                max-height: 90vh; /* Ensure visibility on smaller screens */
            }

            .form-group input {
                padding: 10px;
                font-size: 15px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 15px;
            }
            
            .control-btn {
                padding: 7px; /* Ensure tap target size - slightly more padding */
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 10px 12px; /* Further reduced padding */
                min-height: 55px;
            }

            .header h1 {
                font-size: 1.0em; /* Smaller title */
                margin-right: 8px;
                 white-space: nowrap; /* Prevent title from wrapping */
                overflow: hidden;
                text-overflow: ellipsis; /* Add ellipsis if title is too long */
            }

            .header-controls {
                gap: 8px; /* Smaller gap */
            }
            
            .tts-toggle span {
                display: none; /* Hide emoji/text for TTS toggle on very small screens for space */
            }
            
            .tts-toggle {
                gap: 5px; /* Reduce gap when text is hidden */
            }


            .settings-btn {
                font-size: 0.8em;
                padding: 7px 9px;
                min-width: 45px;
            }

            .toggle-switch {
                width: 40px;
                height: 20px;
            }

            .toggle-slider {
                width: 16px;
                height: 16px;
            }

            .toggle-switch.active .toggle-slider {
                transform: translateX(20px); /* Adjust if needed */
            }

            .chat-messages {
                padding: 10px;
            }

            .message {
                max-width: 92%; /* Allow slightly more width */
                font-size: 0.9em; /* Slightly smaller for very small screens if needed */
                padding: 8px 12px;
                border-radius: 12px; /* Slightly smaller radius for smaller messages */
            }
             .message.user {
                border-bottom-right-radius: 4px; /* Sharper corner for user */
            }
            .message.assistant {
                border-bottom-left-radius: 4px; /* Sharper corner for assistant */
            }


            .input-container {
                padding: 8px 10px;
            }
            
            .message-input {
                padding: 9px 12px;
                font-size: 14px;
                max-height: 100px; /* Adjust max height */
            }

            .send-btn {
                width: 38px;
                height: 38px;
                font-size: 1.0em; /* Adjusted from 1em to 1.0em for clarity, no actual change */
            }
            
            .modal-content {
                padding: 15px;
                max-width: calc(100% - 20px); /* ensure some margin from screen edge */
            }
            
            .modal h2 {
                font-size: 1.15em; /* Slightly adjust */
            }

            .form-group label {
                font-size: 0.85em; /* Slightly adjust */
            }
            .form-group input {
                padding: 8px 10px; /* Adjust padding */
                font-size: 14px;
            }
            .btn { /* Modal buttons */
                padding: 10px 10px; /* Adjust padding for smaller screens */
                font-size: 14px;
                /* flex-basis: 0; */ /* Allow buttons to shrink if needed */
            }
            .control-btn {
                padding: 6px; /* Fine-tuned padding for message controls */
                font-size: 0.8em;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>ü§ñ AI Chat + Amy TTS</h1>
            <div class="header-controls">
                <div class="tts-toggle">
                    <span>üîä</span>
                    <div class="toggle-switch" id="ttsToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <button class="settings-btn" id="settingsBtn">‚öôÔ∏è API</button>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    üëã Hi! I'm your AI assistant powered by DeepSeek. Configure your OpenRouter API key to start chatting!
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="Type your message here..."
                        rows="1"
                    ></textarea>
                    <button id="sendBtn" class="send-btn">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <h2>‚öôÔ∏è API Configuration</h2>
            <div class="form-group">
                <label for="apiKeyInput">OpenRouter API Key:</label>
                <input 
                    type="password" 
                    id="apiKeyInput" 
                    placeholder="sk-or-..."
                    autocomplete="off"
                >
            </div>
            <div class="form-group">
                <label for="systemPromptInput">System Prompt (Optional):</label>
                <input 
                    type="text" 
                    id="systemPromptInput" 
                    placeholder="You are a helpful assistant..."
                    value="You are Amy, a helpful and friendly AI assistant. Respond naturally and conversationally."
                >
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="saveBtn">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        // VITS-Web TTS Class
        class VITSWeb {
            constructor() {
                this.isInitialized = false;
                this.audioContext = null;
            }

            async initialize() {
                if (this.isInitialized) return;
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.isInitialized = true;
                    return true;
                } catch (error) {
                    console.error('Failed to initialize VITS:', error);
                    return false;
                }
            }

            async synthesize(text) {
                if (!this.isInitialized) {
                    await this.initialize();
                }

                return new Promise((resolve, reject) => {
                    if (!('speechSynthesis' in window)) {
                        reject(new Error('Speech synthesis not supported'));
                        return;
                    }

                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // Find Amy-like voice
                    const voices = speechSynthesis.getVoices();
                    const preferredVoices = [
                        'Google US English',
                        'Microsoft Zira - English (United States)',
                        'Samantha',
                        'Alex',
                        'Victoria'
                    ];

                    let selectedVoice = null;
                    for (const preferred of preferredVoices) {
                        selectedVoice = voices.find(voice => 
                            voice.name.includes(preferred) || 
                            (voice.lang.includes('en') && voice.name.toLowerCase().includes('female'))
                        );
                        if (selectedVoice) break;
                    }

                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => voice.lang.startsWith('en')) || voices[0];
                    }

                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }

                    utterance.rate = 0.9;
                    utterance.pitch = 1.1;
                    utterance.volume = 0.8;

                    utterance.onend = () => resolve();
                    utterance.onerror = (event) => reject(new Error(`TTS failed: ${event.error}`));

                    speechSynthesis.speak(utterance);
                });
            }

            stop() {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
            }
        }

        // App State (using in-memory storage instead of localStorage)
        const appState = {
            apiKey: '',
            systemPrompt: 'You are Amy, a helpful and friendly AI assistant. Respond naturally and conversationally.',
            ttsEnabled: true,
            messages: []
        };

        // Initialize components
        const vits = new VITSWeb();
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const ttsToggle = document.getElementById('ttsToggle');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const systemPromptInput = document.getElementById('systemPromptInput');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // Message Management
        function addMessage(content, role, speak = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = content;

            // Add controls for assistant messages
            if (role === 'assistant') {
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'message-controls';
                controlsDiv.innerHTML = `
                    <button class="control-btn" onclick="speakMessage(this)" title="Speak">üîä</button>
                    <button class="control-btn" onclick="copyMessage(this)" title="Copy">üìã</button>
                `;
                messageDiv.appendChild(controlsDiv);
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Auto-speak if TTS is enabled
            if (speak && appState.ttsEnabled && role === 'assistant') {
                speakText(content);
            }

            // Store message
            appState.messages.push({ role, content });
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typing = document.getElementById('typingIndicator');
            if (typing) {
                typing.remove();
            }
        }

        // TTS Functions
        async function speakText(text) {
            try {
                await vits.synthesize(text);
            } catch (error) {
                console.error('TTS Error:', error);
            }
        }

        window.speakMessage = function(btn) {
            const messageContent = btn.closest('.message').textContent;
            speakText(messageContent);
        };

        window.copyMessage = function(btn) {
            const messageContent = btn.closest('.message').textContent;
            navigator.clipboard.writeText(messageContent).then(() => {
                btn.textContent = '‚úì';
                setTimeout(() => btn.textContent = 'üìã', 1000);
            });
        };

        // OpenRouter API Integration
        async function sendToDeepSeek(userMessage) {
            if (!appState.apiKey) {
                throw new Error('Please configure your OpenRouter API key first');
            }

            const messages = [
                { role: 'system', content: appState.systemPrompt },
                ...appState.messages.slice(-10), // Keep last 10 messages for context
                { role: 'user', content: userMessage }
            ];

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${appState.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin || 'https://claude.ai',
                        'X-Title': 'AI Chat with Amy TTS',
                        'Origin': window.location.origin || 'https://claude.ai'
                    },
                    body: JSON.stringify({
                        model: 'deepseek/deepseek-chat-v3-0324:free',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 1000,
                        stream: false
                    })
                });

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error?.message || errorMessage;
                    } catch (e) {
                        // If we can't parse error JSON, use the default message
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                return data.choices[0].message.content;

            } catch (error) {
                // Handle different types of errors
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('‚ùå CORS Error: This app needs to be run from your own server or localhost to access the OpenRouter API. The Claude.ai preview environment blocks external API calls for security reasons.');
                } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    throw new Error('‚ùå Network Error: Unable to connect to OpenRouter API. Please check your internet connection and try again.');
                } else {
                    throw error; // Re-throw other errors as-is
                }
            }
        }

        // Demo/Fallback Response Function
        function getDemoResponse(userMessage) {
            const responses = [
                "I'm Amy, your AI assistant! However, I'm currently running in demo mode because external API calls are restricted in this preview environment.",
                "That's an interesting question! To get real AI responses, you'll need to download this code and run it on your own server or localhost.",
                "I'd love to help you with that! Unfortunately, I can only provide demo responses here. For full functionality, please run this app from your own environment.",
                "Great question! This is a demo response since we can't access the OpenRouter API from this preview. Copy the code to use it with real AI responses!",
                "I understand what you're asking! This preview shows how the chat interface works, but you'll need to run it locally for actual AI conversations."
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            return randomResponse + `\n\nüí° **How to use with real AI:**\n1. Copy this HTML code\n2. Save it as a .html file\n3. Open it in your browser\n4. Add your OpenRouter API key\n5. Enjoy full AI conversations!`;
        }

        // Chat Functions
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            messageInput.value = '';
            adjustTextareaHeight();

            // Show typing indicator
            showTypingIndicator();
            sendBtn.disabled = true;

            try {
                let response;
                
                if (appState.apiKey) {
                    // Try to get real AI response
                    try {
                        response = await sendToDeepSeek(message);
                    } catch (error) {
                        // If API fails, provide helpful error message and demo response
                        hideTypingIndicator();
                        addMessage(error.message, 'system');
                        
                        // Show demo response after error
                        showTypingIndicator();
                        setTimeout(() => {
                            hideTypingIndicator();
                            const demoResponse = getDemoResponse(message);
                            addMessage(demoResponse, 'assistant', true);
                        }, 1500);
                        return;
                    }
                } else {
                    // No API key, provide demo response
                    response = getDemoResponse(message);
                }
                
                // Hide typing and add response
                hideTypingIndicator();
                addMessage(response, 'assistant', true);
                
            } catch (error) {
                hideTypingIndicator();
                addMessage(`‚ùå Unexpected Error: ${error.message}`, 'system');
            } finally {
                sendBtn.disabled = false;
                messageInput.focus();
            }
        }

        // UI Event Handlers
        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        function toggleTTS() {
            appState.ttsEnabled = !appState.ttsEnabled;
            ttsToggle.classList.toggle('active', appState.ttsEnabled);
            
            if (!appState.ttsEnabled) {
                vits.stop();
            }
        }

        function showSettings() {
            apiKeyInput.value = appState.apiKey;
            systemPromptInput.value = appState.systemPrompt;
            settingsModal.classList.remove('hidden');
        }

        function hideSettings() {
            settingsModal.classList.add('hidden');
        }

        function saveSettings() {
            appState.apiKey = apiKeyInput.value.trim();
            appState.systemPrompt = systemPromptInput.value.trim() || 'You are Amy, a helpful and friendly AI assistant.';
            
            hideSettings();
            
            if (appState.apiKey) {
                addMessage('‚úÖ API key configured successfully! You can now chat with me.', 'system');
            }
        }

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        messageInput.addEventListener('input', adjustTextareaHeight);

        ttsToggle.addEventListener('click', toggleTTS);
        settingsBtn.addEventListener('click', showSettings);
        saveBtn.addEventListener('click', saveSettings);
        cancelBtn.addEventListener('click', hideSettings);

        // Modal click outside to close
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                hideSettings();
            }
        });

        // Initialize app
        function init() {
            // Set initial TTS state
            ttsToggle.classList.toggle('active', appState.ttsEnabled);
            
            // Load voices
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => {
                    console.log('Voices loaded:', speechSynthesis.getVoices().length);
                };
            }
            
            // Focus input
            messageInput.focus();
            
            // Show initial setup message
            setTimeout(() => {
                if (!appState.apiKey) {
                    addMessage('üîë Click the "API" button to configure your OpenRouter API key and start chatting!\n\n‚ö†Ô∏è **Note**: This preview environment has CORS restrictions. For full functionality:\n1. Copy this HTML code\n2. Save as a .html file\n3. Open in your browser\n4. Add your API key\n\nYou can still try the demo responses and TTS features here!', 'system');
                }
            }, 1000);
        }

        init();
    </script>
</body>
</html>
