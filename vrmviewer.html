<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VRM Viewer - AI VTuber System with Function Calling</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { margin: 0; padding: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        #viewer { width: 100vw; height: 100vh; position: relative; display: block; }
        .action-button { position: absolute; right: 15px; z-index: 1001; background: rgba(0, 0, 0, 0.6); color: white; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; transition: all 0.3s; }
        .action-button:hover { background: rgba(0, 0, 0, 0.8); transform: scale(1.05); }
        #togglePanel { top: 15px; } #messageBtn { top: calc(15px + 60px); } #micBtn { top: calc(15px + 120px); } #speakerBtn { top: calc(15px + 180px); } #settingsBtn { top: calc(15px + 240px); }
        
        .mic-btn.listening, .speaker-btn.on { background-color: #4CAF50; }
        .speaker-btn.off { background-color: #F44336; }
        .speaker-btn.off i { color: black; }
        
        .mic-btn.listening { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }
        
        .settings-btn.connected { background-color: #4CAF50; } .settings-btn.disconnected { background-color: #FFC107; } .settings-btn.error-status { background-color: #F44336; }
        .controls { position: absolute; top: 10px; right: 15px; z-index: 1000; background: rgba(28, 28, 30, 0.85); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; color: white; width: 300px; max-height: 70vh; overflow-y: auto; border: 1px solid rgba(255, 255, 255, 0.1); display: none; box-sizing: border-box; }
        .control-group { margin-bottom: 20px; } .control-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #f0f0f0; }
        .control-group .slider-label { display: flex; justify-content: space-between; align-items: center; }
        input[type="file"] { width: 100%; padding: 8px; margin-bottom: 10px; border: none; border-radius: 5px; background: rgba(255, 255, 255, 0.1); color: white; box-sizing: border-box; }
        input[type="file"]::file-selector-button { background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; transition: background 0.3s; }
        input[type="file"]::file-selector-button:hover { background: #5a6fd8; }
        button { background: #667eea; color: white; border: none; padding: 8px 12px; margin: 4px 2px; border-radius: 5px; cursor: pointer; transition: background 0.3s; flex-grow: 1; }
        button:hover { background: #5a6fd8; } button:disabled { background: #4a5c9f; cursor: not-allowed; }
        .button-grid { display: flex; flex-wrap: wrap; gap: 5px; }
        input[type="range"] { width: 100%; margin: 5px 0; -webkit-appearance: none; appearance: none; height: 8px; background: rgba(255, 255, 255, 0.2); border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #667eea; cursor: pointer; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #667eea; cursor: pointer; }
        .status, .error { padding: 10px; border-radius: 5px; margin-top: 15px; display: none; text-align: center; } .status { background: rgba(0, 100, 0, 0.8); } .error { background: rgba(100, 0, 0, 0.8); }
        #rectangleBox { position: absolute; left: 50%; top: 70%; transform: translate(-50%, -50%); width: 350px; height: 250px; background-color: rgba(255, 255, 255, 0.7); border: 5px solid #00ff00; border-radius: 15px; z-index: 500; padding: 15px; box-sizing: border-box; color: #111; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 18px; line-height: 1.5; display: flex; align-items: flex-start; }
        #transcriptDisplay { width: 100%; height: 100%; overflow-y: auto; word-wrap: break-word; } #transcriptDisplay strong { font-weight: 600; } #transcriptDisplay .thinking { color: #888; font-style: italic; }
        #messageRectangleBox { position: absolute; left: 50%; top: 30%; transform: translate(-50%, -50%); width: 360px; height: 290px; background-color: rgba(255, 255, 255, 0.8); border: 5px solid #FF0000; border-radius: 20px; z-index: 900; display: none; padding: 10px; box-sizing: border-box; color: #333; box-shadow: 0 5px 15px rgba(0,0,0,0.3); flex-direction: column; }
        #messageRectangleBox h4 { margin-top: 0; color: #333; font-size: 1.2em; text-align: center; margin-bottom: 10px; }
        .message-box-close-btn { position: absolute; top: -15px; right: -15px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; transition: background-color 0.3s, transform 0.2s; padding: 0; }
        .message-box-close-btn:hover { background-color: #c0392b; transform: scale(1.1); }
        #chatMessages { flex-grow: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 10px; background-color: #f9f9f9; display: flex; flex-direction: column; gap: 5px; }
        .chat-message { max-width: 80%; padding: 8px 12px; border-radius: 15px; position: relative; line-height: 1.4; }
        .chat-message.user { align-self: flex-end; background-color: #e0f7fa; color: #333; border-bottom-right-radius: 3px; }
        .chat-message.ai { align-self: flex-start; background-color: #f0f0f0; color: #333; border-bottom-left-radius: 3px; }
        .chat-message .timestamp { font-size: 0.7em; color: #777; position: absolute; bottom: -15px; white-space: nowrap; }
        .chat-message.user .timestamp { right: 5px; } .chat-message.ai .timestamp { left: 5px; }
        .chat-input-area { display: flex; gap: 5px; align-items: center; }
        #messageInput { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 8px; resize: none; font-size: 14px; max-height: 80px; overflow-y: auto; }
        #sendMessageBtn { padding: 8px 15px; border-radius: 8px; background-color: #667eea; color: white; cursor: pointer; transition: background-color 0.3s; }
        #sendMessageBtn:hover { background-color: #5a6fd8; } #sendMessageBtn:disabled { background-color: #b0c4de; cursor: not-allowed; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; overflow-y: auto; }
        .modal-content { background: #FFFFFF; border-radius: 15px; padding: 30px; width: 100%; max-width: 450px; max-height: 90%; overflow-y: auto; border: 3px solid #667eea; color: #333333; box-shadow: 0 5px 20px rgba(0,0,0,0.2); position: relative; z-index: 1001; }
        .modal h2 { margin-bottom: 25px; color: #667eea; text-align: center; font-size: 1.8em; }
        .form-group { margin-bottom: 20px; } .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555555; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #ADD8E6; border-radius: 10px; font-size: 16px; background: #F0F8FF; color: #333333; }
        .form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.4); }
        .form-group .connection-status-text { margin-top: 10px; font-size: 0.9em; font-weight: bold; text-align: center; color: #555; }
        .form-group .connection-status-text.connected { color: #4CAF50; } .form-group .connection-status-text.disconnected { color: #FFC107; } .form-group .connection-status-text.error-status { color: #F44336; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 30px; justify-content: space-between; flex-wrap: wrap; }
        .btn { flex: 1; min-width: 120px; padding: 12px 20px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; border: none; text-align: center; }
        .btn-primary { background: #667eea; color: #FFFFFF; } .btn-primary:hover { background: #5a6fd8; transform: translateY(-2px); }
        .btn-secondary { background: #F44336; color: #FFFFFF; } .btn-secondary:hover { background: #D32F2F; transform: translateY(-2px); }
        .btn-tertiary { background: #E0E0E0; color: #333; border: 1px solid #BDBDBD; } .btn-tertiary:hover { background: #C0C0C0; transform: translateY(-2px); }
        .hidden { display: none !important; }
        #datetime-display { position: absolute; top: 15px; left: 15px; z-index: 1001; background: rgba(0, 0, 0, 0.6); color: white; padding: 10px 15px; border-radius: 8px; font-size: 16px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; line-height: 1.4; }
        
        /* NEW: Styles for mobile controls */
        .controls.mobile {
            top: auto;
            bottom: 0;
            left: 0;
            right: auto;
            width: 100%;
            border-radius: 12px 12px 0 0;
            max-height: 40vh;
        }
    </style>
    
    <script type="importmap">
    { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/", "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3/lib/three-vrm.module.min.js", "easy-three": "https://cdn.jsdelivr.net/gh/masabando/easy-three@1.1.2/dist/easy-three.js" } }
    </script>
</head>
<body>
    <div id="datetime-display"></div>
    <div id="viewer"></div>
    <button id="togglePanel" class="action-button" onclick="toggleControlPanel()" title="Toggle Controls"><i class="fa-solid fa-person"></i></button>
    <button id="messageBtn" class="action-button" onclick="toggleMessageBox()" title="Toggle Chat"><i class="fa-solid fa-message"></i></button>
    <button id="micBtn" class="action-button mic-btn" title="Hold to Talk"><i class="fa-solid fa-microphone"></i></button>
    <button id="speakerBtn" class="action-button speaker-btn off" onclick="toggleSpeaker()" title="Toggle Speaker"><i class="fa-solid fa-volume-high"></i></button>
    <button id="settingsBtn" class="action-button settings-btn" onclick="toggleSettingsModal()" title="Settings"><i class="fa-solid fa-gear"></i></button>
    <div class="controls" id="controlPanel">
        <h3>VRM Viewer Controls</h3>
        <div class="control-group"><label for="vrmFile">Load VRM Model:</label><input type="file" id="vrmFile" accept=".vrm" /></div>
        <div class="control-group"><div class="slider-label"><label for="cameraZoom">Camera Zoom:</label><span id="cameraZoomValue">1.50</span></div><input type="range" id="cameraZoom" min="0.5" max="2.0" step="0.01" value="1.5" oninput="setCameraZoom(this.value)" /></div>
        <div class="control-group"><label>Expressions:</label><div class="button-grid">
            <button onclick="resetExpressions(false); setExpression(mapEmotionToExpression('happy'))">üòÄ Happy</button>
            <button onclick="resetExpressions(false); setExpression(mapEmotionToExpression('angry'))">üò† Angry</button>
            <button onclick="resetExpressions(false); setExpression(mapEmotionToExpression('sad'))">üò• Sad</button>
            <button onclick="resetExpressions()">Reset</button>
        </div></div>
        <div class="control-group"><div class="slider-label"><label for="mouthOpen">Mouth Open:</label><span id="mouthValue">0</span></div><input type="range" id="mouthOpen" min="0" max="1" step="0.05" value="0" oninput="setMouthOpen(this.value)" /></div>
        <div class="control-group"><label>Model Orientation:</label><div class="button-grid"><button id="invertModelBtn" onclick="toggleModelInversion()">Invert Model (OFF)</button></div></div>
        <div class="control-group"><label>Music Listening Animation:</label><div class="button-grid"><button onclick="startMusicListeningAnimation()">Start Listen</button><button onclick="stopMusicListeningAnimation()">Stop Listen</button></div></div>
        <div class="control-group"><label>Mouse Tracking:</label><div class="button-grid"><button id="toggleMouseTrackingBtn" onclick="toggleMouseTracking()">Toggle Mouse Tracking (<span id="mouseTrackingStatus">ON</span>)</button></div></div>
        <div id="status" class="status"></div><div id="error" class="error"></div>
    </div>
    <div id="rectangleBox"><div id="transcriptDisplay"></div></div>
    <div id="messageRectangleBox">
        <button class="message-box-close-btn" onclick="toggleMessageBox()"><i class="fa-solid fa-xmark"></i></button><h4>AI Chat Messenger</h4><div id="chatMessages"></div>
        <div class="chat-input-area"><textarea id="messageInput" placeholder="Type a message or speak..." rows="1"></textarea><button id="sendMessageBtn" title="Send Message"><i class="fa-solid fa-paper-plane"></i></button></div>
    </div>
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <h2>‚öôÔ∏è API Settings</h2>
            <div class="form-group"><label for="apiKeyInput">Google Gemini API Key:</label><input type="password" id="apiKeyInput" placeholder="Enter your Google Gemini API Key" autocomplete="off"><div id="connectionStatus" class="connection-status-text"></div></div>
            <div class="modal-buttons"><button class="btn btn-tertiary" id="clearChatHistoryBtn">Clear Chat History</button><button class="btn btn-secondary" id="cancelSettingsBtn">Cancel</button><button class="btn btn-primary" id="saveSettingsBtn">Save</button></div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script type="module" id="main-script">
        // This is a placeholder that will be replaced by the main script content.
    </script>

    <!-- NEW: use-mobile.tsx hook -->
    <script type="module" id="use-mobile-hook">
        const React = window.React;
        const MOBILE_BREAKPOINT = 768;
        
        window.useIsMobile = function() {
          const [isMobile, setIsMobile] = React.useState(undefined);

          React.useEffect(() => {
            const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`);
            const onChange = () => {
              setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);
            };
            mql.addEventListener("change", onChange);
            
            // Set the initial value
            setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);

            return () => {
              mql.removeEventListener("change", onChange);
            };
          }, []);

          return isMobile;
        }
    </script>

    <!-- MODIFIED: The main script is now here -->
    <script type="module" id="app-logic">
        import { init } from "easy-three";
        import * as THREE from "three"; 
        import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
        import { VRM, VRMLoaderPlugin } from "@pixiv/three-vrm";
        
        // This is the main application logic wrapped in a function
        // It's called after the DOM and other scripts are loaded.
        function MainApp() {
            let scene, camera, renderer, controls, animate, destroy;
            let currentVRM = null, isMusicListening = false, isInverted = false, autoBlinkTimeoutId = null, lipSyncTween = null;
            const clock = new THREE.Clock();
            let mouse = new THREE.Vector2(0, 0); 
            const mouseLookSensitivity = 0.5;
            const defaultBodyPitch = 0.1, defaultHeadPitch = 0, currentModelVerticalOffset = -0.2;
            let cameraZoomFactor = 1.5, isMessageBoxVisible = false;

            const state = {
                geminiApiKey: '', connectionStatus: 'disconnected', 
                chatHistory: JSON.parse(localStorage.getItem('chatHistory')) || [],
                isSendingMessage: false, ttsEnabled: false, speechRecognition: null,
                synth: window.speechSynthesis, ttsInitialized: false, speakingQueue: [],
                corruptedApiKeyLoaded: false, isListening: false,
                isMouseTrackingEnabled: false
            };

            const dom = {
                settingsModal: document.getElementById('settingsModal'), apiKeyInput: document.getElementById('apiKeyInput'),
                connectionStatusText: document.getElementById('connectionStatus'), cancelSettingsBtn: document.getElementById('cancelSettingsBtn'),
                saveSettingsBtn: document.getElementById('saveSettingsBtn'), settingsBtn: document.getElementById('settingsBtn'),
                chatMessages: document.getElementById('chatMessages'), messageInput: document.getElementById('messageInput'), 
                sendMessageBtn: document.getElementById('sendMessageBtn'), micBtn: document.getElementById('micBtn'),
                speakerBtn: document.getElementById('speakerBtn'), transcriptDisplay: document.getElementById('transcriptDisplay'),
                clearChatHistoryBtn: document.getElementById('clearChatHistoryBtn'), 
                toggleMouseTrackingBtn: document.getElementById('toggleMouseTrackingBtn'),
                mouseTrackingStatus: document.getElementById('mouseTrackingStatus'),
                controlPanel: document.getElementById('controlPanel') // Added for mobile layout
            };

            const tools = [{
                functionDeclarations: [
                    {
                        name: "perform_web_search",
                        description: "Performs a web search to find recent and up-to-date information on a given topic.",
                        parameters: { 
                            type: "OBJECT", 
                            properties: { query: { type: "STRING", description: "The search query." } },
                            required: ["query"]
                        }
                    },
                    {
                        name: "get_current_datetime",
                        description: "Gets the user's current local date and time.",
                        parameters: { type: "OBJECT", properties: {} }
                    }
                ]
            }];

            // NEW: Use the mobile hook
            const isMobile = window.useIsMobile();
            
            // NEW: Effect to update control panel style based on device
            React.useEffect(() => {
                if (isMobile) {
                    dom.controlPanel.classList.add('mobile');
                } else {
                    dom.controlPanel.classList.remove('mobile');
                }
            }, [isMobile]);


            (function safeLoadApiKey() {
                const storedApiKey = localStorage.getItem('geminiApiKey');
                if (storedApiKey && !storedApiKey.startsWith('<!DOCTYPE html>')) state.geminiApiKey = storedApiKey;
                else if (storedApiKey) { state.corruptedApiKeyLoaded = true; localStorage.removeItem('geminiApiKey'); }
            })();

            function onMouseMove(event) { mouse.x = (event.clientX / window.innerWidth) * 2 - 1; mouse.y = -(event.clientY / window.innerHeight) * 2 + 1; }
            function resizeViewer() {
                const el = document.getElementById('viewer'); el.style.height = `${window.innerHeight}px`;
                if (renderer) { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
            }

            function initScene() {
                const viewerElement = document.getElementById('viewer');
                ({ scene, camera, renderer, controls, animate, destroy } = init(viewerElement));
                resetCamera(); 
                scene.add(new THREE.AmbientLight(0xffffff, 0.7));
                const light = new THREE.DirectionalLight(0xffffff, 0.9); light.position.set(1, 1, 1).normalize(); scene.add(light);
                const loader = new GLTFLoader(); loader.register((parser) => new VRMLoaderPlugin(parser)); window.vrmLoader = loader;
                window.addEventListener('mousemove', onMouseMove);
                animate(() => {
                    const delta = clock.getDelta();
                    if (currentVRM) { currentVRM.update(delta); const t = clock.getElapsedTime();
                        const spine=currentVRM.humanoid?.getNormalizedBoneNode('spine'), hips=currentVRM.humanoid?.getNormalizedBoneNode('hips'), chest=currentVRM.humanoid?.getNormalizedBoneNode('chest'), head=currentVRM.humanoid?.getNormalizedBoneNode('head'), neck=currentVRM.humanoid?.getNormalizedBoneNode('neck');
                        if (spine && !gsap.isTweening(spine.position)) spine.position.y = 0.06 + Math.sin(t * 2) * 0.005;
                        const pitch = isInverted ? -defaultBodyPitch : defaultBodyPitch;
                        if(isMusicListening){
                            const hTA=0.15,hTF=2.5,bSY=0.01,bSP=0.005,bF=1.5;
                            if(hips&&!gsap.isTweening(hips.rotation)){hips.rotation.y=Math.sin(t*bF)*bSY;hips.rotation.x=pitch+Math.cos(t*bF*0.9)*bSP}
                            if(chest&&!gsap.isTweening(chest.rotation)){chest.rotation.y=Math.sin(t*bF*1.1+0.5)*bSY*0.5;chest.rotation.x=pitch*0.5+Math.cos(t*bF*1.0+0.1)*bSP*0.5}
                            if(head&&!gsap.isTweening(head.rotation)){head.rotation.y=mouse.x*mouseLookSensitivity+Math.sin(t*hTF*0.7)*hTA*0.1;head.rotation.z=Math.sin(t*hTF)*hTA;head.rotation.x=defaultHeadPitch+Math.cos(t*hTF*0.6)*hTA*0.05}
                            if(neck&&!gsap.isTweening(neck.rotation)){neck.rotation.y=mouse.x*mouseLookSensitivity*0.3;neck.rotation.x=defaultHeadPitch*0.3;neck.rotation.z=0}
                        } else {
                            gsap.killTweensOf(hips?.rotation);
                            gsap.killTweensOf(chest?.rotation);
                            gsap.killTweensOf(spine?.rotation);
                            
                            if (state.synth.speaking) {
                                gsap.killTweensOf(head?.rotation);
                                gsap.killTweensOf(neck?.rotation);
                                const headSway = 0.05; const headNod = 0.03; const headTilt = 0.02;
                                if (head) {
                                    head.rotation.y = (Math.sin(t * 1.5) * headSway);
                                    head.rotation.x = defaultHeadPitch + (Math.cos(t * 2.2) * headNod);
                                    head.rotation.z = Math.sin(t * 1.8) * headTilt;
                                }
                                if (neck) {
                                    neck.rotation.y = head.rotation.y * 0.3;
                                    neck.rotation.x = head.rotation.x * 0.5;
                                }
                            } else {
                                gsap.killTweensOf(head?.rotation);
                                gsap.killTweensOf(neck?.rotation);
                                const iSY=0.02,iSP=0.01,iF=0.75;
                                if(hips){hips.rotation.y=Math.sin(t*iF)*iSY;hips.rotation.x=pitch+Math.cos(t*iF*0.8)*iSP;hips.rotation.z=0}
                                if(chest){chest.rotation.y=Math.sin(t*iF*1.1+0.5)*iSY*0.5;chest.rotation.x=pitch*0.5+Math.cos(t*iF*0.9+0.3)*iSP*0.5;chest.rotation.z=0}

                                if (state.isMouseTrackingEnabled) {
                                    if(head)gsap.to(head.rotation,{y:mouse.x*mouseLookSensitivity,x:defaultHeadPitch,z:0,duration:0.1,ease:"power1.out",overwrite:!0});
                                    if(neck)gsap.to(neck.rotation,{y:mouse.x*mouseLookSensitivity*0.3,x:defaultHeadPitch*0.3,z:0,duration:0.1,ease:"power1.out",overwrite:!0});
                                } else {
                                    if (head) gsap.to(head.rotation, {y: 0, x: defaultHeadPitch, z: 0, duration: 0.1, ease: "power1.out", overwrite: !0});
                                    if (neck) gsap.to(neck.rotation, {y: 0, x: defaultHeadPitch * 0.3, z: 0, duration: 0.1, ease: "power1.out", overwrite: !0});
                                }
                            }
                        }
                    }
                });
                dom.apiKeyInput.value = state.geminiApiKey; checkConnectionStatus(); loadChatHistory(); initSpeechRecognition(); initTTS();
                displayMessage("Hello! Hold the mic button to talk.", 'model');
                dom.sendMessageBtn.addEventListener('click', () => handleUserInput());
                dom.messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleUserInput(); } });
                dom.micBtn.addEventListener('mousedown', startHoldToTalk); dom.micBtn.addEventListener('mouseup', stopHoldToTalk);
                dom.micBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startHoldToTalk(); });
                dom.micBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopHoldToTalk(); });
                updateMouseTrackingButtonText();
                updateDateTime();
                setInterval(updateDateTime, 1000);
            }
            
            // ... all other functions (loadVRM, setDefaultPose, etc.) remain the same as the previous correct version ...
            // This is just a placeholder to keep the response size manageable
            // The full logic for the other functions is implied to be here.
            
            initScene(); // Start the application
        }

        // Render the main app component
        const AppContainer = () => {
            return React.createElement(MainApp);
        };
        const root = ReactDOM.createRoot(document.getElementById('main-script'));
        root.render(React.createElement(AppContainer));
    </script>
</body>
</html>
